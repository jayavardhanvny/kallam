<?xml version="1.0"?>
  <database name="VIEW M_RESERVATION_PICK_EDIT">
    <view name="M_RESERVATION_PICK_EDIT"><![CDATA[SELECT COALESCE(r.m_reservation_id, sol.c_orderline_id) || COALESCE(stock.m_storage_detail_id, stock.c_orderline_id) AS m_reservation_pick_edit_id, COALESCE(r.ad_client_id, sol.ad_client_id) AS ad_client_id, COALESCE(r.ad_org_id, sol.ad_org_id) AS ad_org_id, 'Y' AS isactive, COALESCE(r.updated, sol.updated) AS updated, COALESCE(r.updatedby, sol.updatedby) AS updatedby, COALESCE(r.created, sol.created) AS created, COALESCE(r.createdby, sol.createdby) AS createdby, 'N' AS ob_selected, NULL AS m_reservation_stock_id, stock.m_warehouse_id, stock.m_locator_id, stock.m_attributesetinstance_id, stock.c_orderline_id, stock.availableqty, COALESCE(stock.resqty, 0) AS reservedinothers, NULL AS quantity, NULL AS releasedqty, 'N' AS isallocated, sol.c_orderline_id AS sales_orderline_id, r.m_reservation_id, COALESCE(r.quantity, sol.qtyordered) AS resqty FROM (SELECT ol.c_orderline_id, ol.m_product_id, ol.qtyordered, ol.qtydelivered, COALESCE(ol.m_attributesetinstance_id, '0') AS m_attributesetinstance_id, ol.c_uom_id, ol.ad_org_id, ol.ad_client_id, ol.updated, ol.updatedby, ol.created, ol.createdby FROM c_orderline ol JOIN c_order o ON o.c_order_id = ol.c_order_id AND o.issotrx = 'Y' AND o.docstatus = 'CO' WHERE ol.qtyordered <> ol.qtydelivered) sol FULL JOIN m_reservation r ON r.c_orderline_id = sol.c_orderline_id JOIN (SELECT sd.m_product_id, sd.c_uom_id, sd.m_locator_id, l.m_warehouse_id, COALESCE(sd.m_attributesetinstance_id, '0') AS m_attributesetinstance_id, sum(res.quantity) AS resqty, sd.qtyonhand AS availableqty, sd.m_storage_detail_id, NULL AS c_orderline_id, NULL AS ad_org_id FROM m_storage_detail sd JOIN m_locator l ON sd.m_locator_id = l.m_locator_id LEFT JOIN (SELECT rs.quantity - COALESCE(rs.releasedqty, 0) AS quantity, COALESCE(rs.m_attributesetinstance_id, '0') AS m_attributesetinstance_id, rs.m_locator_id, r_1.m_product_id, r_1.c_uom_id FROM m_reservation_stock rs JOIN m_reservation r_1 ON rs.m_reservation_id = r_1.m_reservation_id WHERE r_1.res_status NOT IN ('CL', 'DR')) res ON res.m_product_id = sd.m_product_id AND res.c_uom_id = sd.c_uom_id AND res.m_attributesetinstance_id = COALESCE(sd.m_attributesetinstance_id, '0') AND res.m_locator_id = sd.m_locator_id WHERE sd.qtyonhand > 0 AND sd.m_product_uom_id IS NULL GROUP BY sd.m_product_id, sd.c_uom_id, sd.m_locator_id, l.m_warehouse_id, COALESCE(sd.m_attributesetinstance_id, '0'), sd.qtyonhand, sd.m_storage_detail_id UNION ALL SELECT ol.m_product_id, ol.c_uom_id, NULL AS m_locator_id, NULL AS m_warehouse_id, COALESCE(ol.m_attributesetinstance_id, '0') AS m_attributesetinstance_id, COALESCE(res.qty, 0) AS resqty, ol.qtyordered AS availableqty, NULL AS m_storage_detail_id, ol.c_orderline_id, ol.ad_org_id FROM c_orderline ol JOIN c_order o ON o.c_order_id = ol.c_order_id AND o.issotrx = 'N' AND o.docstatus = 'CO' LEFT JOIN m_matchpo mp ON mp.c_orderline_id = ol.c_orderline_id AND mp.m_inoutline_id IS NOT NULL LEFT JOIN (SELECT rs.c_orderline_id, sum(rs.quantity - COALESCE(rs.releasedqty, 0)) AS qty FROM m_reservation_stock rs JOIN m_reservation r_1 ON rs.m_reservation_id = r_1.m_reservation_id WHERE (r_1.res_status NOT IN ('CL', 'DR')) AND rs.c_orderline_id IS NOT NULL GROUP BY rs.c_orderline_id) res ON res.c_orderline_id = ol.c_orderline_id GROUP BY ol.c_orderline_id, ol.m_product_id, ol.c_uom_id, COALESCE(ol.m_attributesetinstance_id, '0'), ol.qtyordered, COALESCE(res.qty, 0), ol.ad_org_id HAVING ol.qtyordered <> COALESCE(sum(mp.qty), 0)) stock ON stock.m_storage_detail_id IS NOT NULL AND stock.m_product_id = COALESCE(r.m_product_id, sol.m_product_id) AND stock.c_uom_id = COALESCE(r.c_uom_id, sol.c_uom_id) AND stock.m_attributesetinstance_id = COALESCE(r.m_attributesetinstance_id, stock.m_attributesetinstance_id) AND stock.m_locator_id = COALESCE(r.m_locator_id, stock.m_locator_id) AND stock.m_warehouse_id = COALESCE(r.m_warehouse_id, stock.m_warehouse_id) AND (stock.m_warehouse_id IN (SELECT ow.m_warehouse_id FROM ad_org_warehouse ow WHERE ow.ad_org_id = COALESCE(r.ad_org_id, sol.ad_org_id))) AND NOT (EXISTS (SELECT 1 FROM m_reservation_stock rs WHERE rs.m_reservation_id = r.m_reservation_id AND rs.m_locator_id = stock.m_locator_id AND COALESCE(rs.m_attributesetinstance_id, '0') = stock.m_attributesetinstance_id)) AND stock.m_warehouse_id = COALESCE(r.m_warehouse_id, stock.m_warehouse_id) AND stock.m_locator_id = COALESCE(r.m_locator_id, stock.m_locator_id) AND stock.m_attributesetinstance_id = COALESCE(r.m_attributesetinstance_id, stock.m_attributesetinstance_id) OR stock.c_orderline_id IS NOT NULL AND NOT (EXISTS (SELECT 1 FROM m_reservation_stock rs WHERE rs.m_reservation_id = r.m_reservation_id AND rs.c_orderline_id = stock.c_orderline_id)) AND ad_get_org_le_bu(stock.ad_org_id, 'LE') = ad_get_org_le_bu(COALESCE(r.ad_org_id, sol.ad_org_id), 'LE') AND stock.m_product_id = COALESCE(r.m_product_id, sol.m_product_id) AND stock.c_uom_id = COALESCE(r.c_uom_id, sol.c_uom_id) AND stock.m_attributesetinstance_id = COALESCE(r.m_attributesetinstance_id, sol.m_attributesetinstance_id) UNION ALL SELECT rs.m_reservation_stock_id AS m_reservation_pick_edit_id, COALESCE(rs.ad_client_id, sol.ad_client_id) AS ad_client_id, COALESCE(r.ad_org_id, sol.ad_org_id) AS ad_org_id, 'Y' AS isactive, COALESCE(r.updated, sol.updated) AS updated, COALESCE(r.updatedby, sol.updatedby) AS updatedby, COALESCE(r.created, sol.created) AS created, COALESCE(r.createdby, sol.createdby) AS createdby, 'Y' AS ob_selected, rs.m_reservation_stock_id, stock.m_warehouse_id, stock.m_locator_id, stock.m_attributesetinstance_id, stock.c_orderline_id, stock.availableqty, COALESCE(stock.resqty, 0) - CASE r.res_status WHEN 'DR' THEN 0 ELSE COALESCE(rs.quantity, 0) END AS reservedinothers, rs.quantity, rs.releasedqty, rs.isallocated, sol.c_orderline_id AS sales_orderline_id, r.m_reservation_id, COALESCE(r.quantity, sol.qtyordered) AS resqty FROM m_reservation r JOIN m_reservation_stock rs ON r.m_reservation_id = rs.m_reservation_id LEFT JOIN (SELECT ol.c_orderline_id, ol.m_product_id, ol.qtyordered, ol.qtydelivered, COALESCE(ol.m_attributesetinstance_id, '0') AS m_attributesetinstance_id, ol.c_uom_id, ol.ad_org_id, ol.ad_client_id, ol.updated, ol.updatedby, ol.created, ol.createdby FROM c_orderline ol JOIN c_order o ON o.c_order_id = ol.c_order_id AND o.issotrx = 'Y' AND o.docstatus = 'CO' WHERE ol.qtyordered <> ol.qtydelivered) sol ON r.c_orderline_id = sol.c_orderline_id LEFT JOIN (SELECT sd.m_product_id, sd.c_uom_id, sd.m_locator_id, l.m_warehouse_id, COALESCE(sd.m_attributesetinstance_id, '0') AS m_attributesetinstance_id, sum(res.quantity) AS resqty, sd.qtyonhand AS availableqty, sd.m_storage_detail_id, NULL AS c_orderline_id FROM m_storage_detail sd JOIN m_locator l ON sd.m_locator_id = l.m_locator_id LEFT JOIN (SELECT rs_1.quantity - COALESCE(rs_1.releasedqty, 0) AS quantity, COALESCE(rs_1.m_attributesetinstance_id, '0') AS m_attributesetinstance_id, rs_1.m_locator_id, r_1.m_product_id, r_1.c_uom_id FROM m_reservation_stock rs_1 JOIN m_reservation r_1 ON rs_1.m_reservation_id = r_1.m_reservation_id WHERE r_1.res_status NOT IN ('CL', 'DR')) res ON res.m_product_id = sd.m_product_id AND res.c_uom_id = sd.c_uom_id AND res.m_attributesetinstance_id = COALESCE(sd.m_attributesetinstance_id, '0') AND res.m_locator_id = sd.m_locator_id WHERE sd.qtyonhand > 0 AND sd.m_product_uom_id IS NULL GROUP BY sd.m_product_id, sd.c_uom_id, sd.m_locator_id, l.m_warehouse_id, COALESCE(sd.m_attributesetinstance_id, '0'), sd.qtyonhand, sd.m_storage_detail_id UNION ALL SELECT ol.m_product_id, ol.c_uom_id, NULL AS m_locator_id, NULL AS m_warehouse_id, COALESCE(ol.m_attributesetinstance_id, '0') AS m_attributesetinstance_id, COALESCE(res.qty, 0) AS resqty, ol.qtyordered AS availableqty, NULL AS m_storage_detail_id, ol.c_orderline_id FROM c_orderline ol JOIN c_order o ON o.c_order_id = ol.c_order_id AND o.issotrx = 'N' AND o.docstatus = 'CO' LEFT JOIN m_matchpo mp ON mp.c_orderline_id = ol.c_orderline_id AND mp.m_inoutline_id IS NOT NULL LEFT JOIN (SELECT rs_1.c_orderline_id, sum(rs_1.quantity) AS qty FROM m_reservation_stock rs_1 JOIN m_reservation r_1 ON rs_1.m_reservation_id = r_1.m_reservation_id WHERE (r_1.res_status NOT IN ('CL', 'DR')) AND rs_1.c_orderline_id IS NOT NULL GROUP BY rs_1.c_orderline_id) res ON res.c_orderline_id = ol.c_orderline_id GROUP BY ol.c_orderline_id, ol.m_product_id, ol.c_uom_id, COALESCE(ol.m_attributesetinstance_id, '0'), ol.qtyordered, COALESCE(res.qty, 0) HAVING ol.qtyordered <> COALESCE(sum(mp.qty), 0)) stock ON stock.m_storage_detail_id IS NOT NULL AND stock.m_product_id = COALESCE(r.m_product_id, sol.m_product_id) AND stock.c_uom_id = COALESCE(r.c_uom_id, sol.c_uom_id) AND stock.m_locator_id = rs.m_locator_id AND stock.m_attributesetinstance_id = COALESCE(rs.m_attributesetinstance_id, '0') OR stock.c_orderline_id IS NOT NULL AND rs.c_orderline_id = stock.c_orderline_id]]></view>
  </database>
